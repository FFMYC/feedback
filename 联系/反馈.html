<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åé¦ˆå»ºè®® - F_F_M_YC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        body { background-color: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; color: #38a038; border: 2px solid #ff0000; background: white; border-radius: 5px; cursor: pointer; transition: all 0.3s; text-decoration: none; margin-bottom: 20px; }
        .back-btn:hover { background: #0000008a; color: white; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); padding: 40px; }
        h1 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 15px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 16px; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3498db; }
        .form-textarea { min-height: 150px; resize: vertical; }
        .form-hint { font-size: 13px; color: #7f8c8d; margin-top: 5px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 30px; border-radius: 4px; font-size: 16px; cursor: pointer; border: none; transition: background-color 0.3s; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #f5f5f5; color: #333; }
        .btn-secondary:hover { background-color: #e8e8e8; }
        .success-info { margin-top: 20px; padding: 15px; background-color: #d4edda; border-radius: 4px; border-left: 4px solid #28a745; display: none; }
        .success-info h3 { margin-bottom: 10px; color: #28a745; }
    </style>
</head>
<body>
    <a href="main.html" class="back-btn">â† è¿”å›è”ç³»</a>
    <div class="container">
        <h1>ğŸ’¬ åé¦ˆå»ºè®®</h1>
        
        <form id="feedback-form">
            <div class="form-group">
                <label class="form-label">æ ‡ç­¾ *</label>
                <select class="form-select" id="feedback-tag" required>
                    <option value="">è¯·é€‰æ‹©æ ‡ç­¾</option>
                </select>
                <p class="form-hint">é€‰æ‹©"å…¶ä»–"å¯è‡ªå®šä¹‰æ ‡ç­¾</p>
            </div>
            
            <div class="form-group" id="custom-tag-group" style="display: none;">
                <label class="form-label">è‡ªå®šä¹‰æ ‡ç­¾ *</label>
                <input type="text" class="form-input" id="custom-tag" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾åç§°">
                <p class="form-hint">è‡ªå®šä¹‰æ ‡ç­¾åç§°ï¼Œç”¨äºåˆ†ç±»åé¦ˆ</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ ‡é¢˜ *</label>
                <input type="text" class="form-input" id="feedback-title" placeholder="è¯·è¾“å…¥åé¦ˆæ ‡é¢˜" required>
                <p class="form-hint">æ–‡ä»¶åæ ¼å¼ï¼šæ ‡ç­¾-æ ‡é¢˜å-ç”¨æˆ·å</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ‚¨çš„å§“å/æ˜µç§° *</label>
                <input type="text" class="form-input" id="feedback-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–æ˜µç§°" required>
                <p class="form-hint">å°†ç”¨äºç”Ÿæˆæ–‡ä»¶åå’Œæ˜¾ç¤ºåœ¨åé¦ˆæ–‡ä»¶ä¸­</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">è¯¦ç»†æè¿° *</label>
                <textarea class="form-textarea" id="feedback-content" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®..." required></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="preview-btn">é¢„è§ˆ</button>
                <button type="submit" class="btn btn-primary" id="submit-btn">æäº¤åé¦ˆ</button>
            </div>
        </form>
        
        <div class="success-info" id="success-info">
            <h3>âœ… æäº¤æˆåŠŸ</h3>
            <p id="success-message"></p>
        </div>
    </div>

    <script>
        let allTags = [];
        
        // åŠ è½½åé¦ˆæ ‡ç­¾åˆ—è¡¨
        async function loadTags() {
            try {
                const response = await fetch('./æ ‡ç­¾/metadata.json');
                if (response.ok) {
                    const data = await response.json();
                    allTags = data.tags || [];
                    // ä¿®æ”¹æ ‡ç­¾åç§°ï¼šé—®é¢˜ -> bug
                    allTags.forEach(tag => {
                        if (tag.name === 'é—®é¢˜') {
                            tag.name = 'bug';
                        }
                    });
                    updateTagSelect();
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤æ ‡ç­¾
                    allTags = [
                        { id: 'tag_1', name: 'å»ºè®®', description: 'åŠŸèƒ½å»ºè®®å’Œæ”¹è¿›' },
                        { id: 'tag_2', name: 'bug', description: 'é—®é¢˜æŠ¥å‘Šå’Œbugåé¦ˆ' },
                        { id: 'tag_3', name: 'å…¶ä»–', description: 'å…¶ä»–ç±»å‹çš„åé¦ˆ' }
                    ];
                    updateTagSelect();
                }
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ ‡ç­¾
                allTags = [
                    { id: 'tag_1', name: 'å»ºè®®', description: 'åŠŸèƒ½å»ºè®®å’Œæ”¹è¿›' },
                    { id: 'tag_2', name: 'bug', description: 'é—®é¢˜æŠ¥å‘Šå’Œbugåé¦ˆ' },
                    { id: 'tag_3', name: 'å…¶ä»–', description: 'å…¶ä»–ç±»å‹çš„åé¦ˆ' }
                ];
                updateTagSelect();
            }
        }
        
        // æ›´æ–°æ ‡ç­¾é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateTagSelect() {
            const select = document.getElementById('feedback-tag');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ ‡ç­¾</option>';
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.name;
                option.textContent = tag.name;
                select.appendChild(option);
            });
        }
        
        // ç›‘å¬æ ‡ç­¾å˜åŒ–ï¼Œæ˜¾ç¤º/éšè—è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥
        document.getElementById('feedback-tag').addEventListener('change', function() {
            const customTagGroup = document.getElementById('custom-tag-group');
            if (this.value === 'å…¶ä»–') {
                customTagGroup.style.display = 'block';
                document.getElementById('custom-tag').required = true;
            } else {
                customTagGroup.style.display = 'none';
                document.getElementById('custom-tag').required = false;
                document.getElementById('custom-tag').value = '';
            }
        });
        
        // ç”Ÿæˆæ–‡ä»¶åï¼šæ ‡ç­¾-æ ‡é¢˜å-ç”¨æˆ·å
        function generateFileName() {
            const tagSelect = document.getElementById('feedback-tag');
            const customTag = document.getElementById('custom-tag').value.trim();
            const title = document.getElementById('feedback-title').value.trim();
            const name = document.getElementById('feedback-name').value.trim();
            
            let tagName = tagSelect.value;
            if (tagName === 'å…¶ä»–' && customTag) {
                tagName = customTag;
            }
            
            if (tagName && title && name) {
                return `${tagName}-${title}-${name}`;
            }
            return '';
        }
        
        // æ£€æŸ¥é‡åå¹¶æ·»åŠ åºå·
        async function checkDuplicateAndAddSequence(baseFileName) {
            try {
                const response = await fetch('/api/check-feedback-duplicate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ baseTitle: baseFileName })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.exists) {
                        return `${baseFileName}-${result.sequence}`;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥é‡åå¤±è´¥:', error);
            }
            return baseFileName;
        }
        
        document.getElementById('feedback-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tagSelect = document.getElementById('feedback-tag').value;
            const customTag = document.getElementById('custom-tag').value.trim();
            const title = document.getElementById('feedback-title').value.trim();
            const name = document.getElementById('feedback-name').value.trim();
            const content = document.getElementById('feedback-content').value.trim();
            
            let tagName = tagSelect;
            if (tagName === 'å…¶ä»–') {
                if (!customTag) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾');
                    return;
                }
                tagName = customTag;
            }
            
            if (!tagSelect) {
                alert('è¯·é€‰æ‹©æ ‡ç­¾');
                return;
            }
            
            if (!title) {
                alert('è¯·è¾“å…¥æ ‡é¢˜');
                return;
            }
            
            if (!name) {
                alert('è¯·è¾“å…¥æ‚¨çš„å§“å/æ˜µç§°');
                return;
            }
            
            // ç”Ÿæˆæ–‡ä»¶å
            const baseFileName = `${tagName}-${title}-${name}`;
            
            // æ£€æŸ¥é‡åå¹¶æ·»åŠ åºå·
            const finalFileName = await checkDuplicateAndAddSequence(baseFileName);
            
            const feedbackData = {
                title: title,
                fileName: finalFileName,
                tag: tagName,
                publisher: name,
                content: content
            };
            
            try {
                const response = await fetch('/save-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('success-info').style.display = 'block';
                    document.getElementById('success-message').textContent = `æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æ–‡ä»¶å·²ä¿å­˜ä¸ºï¼š${finalFileName}`;
                    document.getElementById('feedback-form').reset();
                    document.getElementById('custom-tag-group').style.display = 'none';
                } else {
                    alert('æäº¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                console.error('æäº¤å¤±è´¥:', error);
            }
        });
        
        document.getElementById('preview-btn').addEventListener('click', function() {
            const tagSelect = document.getElementById('feedback-tag').value;
            const customTag = document.getElementById('custom-tag').value.trim();
            const title = document.getElementById('feedback-title').value.trim();
            const name = document.getElementById('feedback-name').value.trim();
            const content = document.getElementById('feedback-content').value.trim();
            
            let tagName = tagSelect;
            if (tagName === 'å…¶ä»–' && customTag) {
                tagName = customTag;
            }
            
            if (!tagSelect || !title || !name || !content) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            alert('é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...\n\næ ‡ç­¾: ' + tagName + '\næ ‡é¢˜: ' + title + '\næäº¤äºº: ' + name + '\næ–‡ä»¶å: ' + `${tagName}-${title}-${name}\nå†…å®¹: ` + content.substring(0, 50) + '...');
        });
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ ‡ç­¾
        window.addEventListener('DOMContentLoaded', loadTags);
    </script>
</body>
</html>